name: Reusable Build and Preview

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        type: string
        default: '20'
      start-preview-server:
        description: 'Whether to start a preview server after building'
        type: boolean
        default: false
      artifact-name:
        description: 'Name for the build artifact'
        type: string
        default: 'build-artifact'
      artifact-retention-days:
        description: 'Number of days to retain the build artifact'
        type: number
        default: 7
    outputs:
      artifact-id:
        description: 'The ID of the uploaded build artifact'
        value: ${{ jobs.build.outputs.artifact-id }}

jobs:
  build:
    name: Build Project
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      artifact-id: ${{ steps.upload.outputs.artifact-id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup project with build
        uses: ./.github/actions/setup-project
        with:
          node-version: ${{ inputs.node-version }}
          with-build: 'true'

      - name: Upload build artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: dist/
          retention-days: ${{ inputs.artifact-retention-days }}

      - name: Start preview server
        if: inputs.start-preview-server
        run: |
          npm run preview &
          echo $! > server.pid
        env:
          PORT: 4173

      - name: Wait for server
        if: inputs.start-preview-server
        run: npx wait-on http://localhost:4173 -t 30000
